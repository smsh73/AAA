# 애널리스트 엑셀 파일 등록 가이드

## 문제 상황

`/old_assets/증권사 리서치센터 애널리스트 리스트(반도체 자동차 방산 금융 최종) (1).xlsx` 파일의 데이터가 analysts 페이지에 표시되지 않는 문제가 있었습니다.

## 해결 방법

### 방법 1: 웹 UI를 통한 일괄 등록 (권장)

1. 프론트엔드에서 애널리스트 페이지 접속
2. "일괄 등록" 버튼 클릭
3. Excel 파일 선택
4. 자동으로 데이터베이스에 등록됨

**장점**:
- 사용자 친화적
- 즉시 결과 확인 가능
- 데이터 수집 자동 시작

### 방법 2: Python 스크립트를 통한 등록

```bash
cd apps/api
python scripts/load_analysts_from_excel.py
```

**장점**:
- 대량 데이터 처리에 적합
- 상세한 로그 확인 가능

## 수정 사항

### 1. ExcelParser 컬럼 매핑 개선

엑셀 파일의 실제 컬럼명에 맞게 매핑 추가 (한글 컬럼명 우선):

- `'애널리스트 이름'` → `name` (우선순위 1)
- `'리서치센터'` → `firm` (우선순위 1)
- `'세부 섹터'` → `department` (우선순위 1)
- `'담당 산업'` → `sector` (우선순위 1)

**파일**: `apps/api/app/services/excel_parser.py`

**개선 사항**:
- 한글 인코딩 처리 개선 (`dtype=str` 사용)
- 개별 행 처리 중 오류 발생 시에도 계속 진행
- 컬럼명 매핑 우선순위 조정 (한글 컬럼명 우선)

### 2. 프론트엔드 일괄 등록 기능 추가

애널리스트 페이지에 Excel 파일 업로드 기능 추가:

- "일괄 등록" 버튼
- 파일 선택 UI
- 업로드 진행 상황 표시
- 등록 결과 표시

**파일**: `apps/web/src/app/analysts/page.tsx`

### 3. Redis/Celery 의존성 제거

엑셀 업로드 시 Redis가 없어도 정상 동작하도록 수정:

- Celery 작업 호출을 try-except로 감싸서 Redis 연결 실패 시에도 애널리스트 등록은 성공
- 데이터 수집 자동 시작은 Redis가 있을 때만 동작
- Redis가 없어도 애널리스트 등록은 정상 동작

**파일**: `apps/api/app/services/analyst_service.py`

## 엑셀 파일 구조

현재 엑셀 파일의 컬럼 구조:

| 컬럼명 | 매핑 필드 | 설명 |
|--------|----------|------|
| 리서치센터 | firm | 증권사명 |
| 담당 산업 | sector | 섹터 (반도체, 자동차, 방산, 금융) |
| 세부 섹터 | department | 부서 |
| 애널리스트 이름 | name | 애널리스트 이름 |

## 사용 방법

### 웹 UI 사용

1. 브라우저에서 `/analysts` 페이지 접속
2. 우측 상단 "일괄 등록" 버튼 클릭
3. Excel 파일 선택 (`.xlsx` 또는 `.xls` 형식)
4. 자동으로 업로드 및 등록 진행
5. 등록 결과 확인

### 스크립트 사용

```bash
# 환경 변수 설정
export DATABASE_URL="postgresql://user:password@localhost:5432/analyst_awards"

# 스크립트 실행
cd apps/api
python scripts/load_analysts_from_excel.py
```

## 예상 결과

엑셀 파일에는 약 65개의 애널리스트 데이터가 있으며, 모두 정상적으로 등록되어야 합니다.

등록 후:
- `/analysts` 페이지에서 목록 확인 가능
- 각 애널리스트의 상세 정보 확인 가능
- 데이터 수집이 자동으로 시작됨

## 문제 해결

### 데이터가 보이지 않는 경우

1. **데이터베이스 연결 확인**
   ```bash
   # PostgreSQL 서비스 실행 확인
   brew services list | grep postgresql
   # 또는
   docker-compose ps
   ```

2. **마이그레이션 확인**
   ```bash
   cd apps/api
   alembic current
   alembic upgrade head
   ```

3. **등록 여부 확인**
   ```bash
   # 데이터베이스에서 직접 확인
   psql -U user -d analyst_awards -c "SELECT COUNT(*) FROM analysts;"
   ```

### 업로드 실패 시

1. **파일 형식 확인**: `.xlsx` 또는 `.xls` 형식인지 확인
2. **컬럼명 확인**: 엑셀 파일의 첫 번째 행이 헤더인지 확인
3. **백엔드 로그 확인**: 에러 메시지 확인

### Redis/Celery 연결 오류

**증상**:
- `Error 99 connecting to localhost:6379. Cannot assign requested address`
- `Internal server error` 발생
- 하지만 애널리스트는 정상적으로 등록됨

**원인**:
- 엑셀 업로드 후 자동으로 데이터 수집을 시작하기 위해 Celery 비동기 작업 호출
- Celery는 Redis를 메시지 브로커로 사용
- Redis가 설치/실행되지 않은 환경에서 연결 실패

**해결 방법**:

1. **Redis 없이 사용 (권장 - 개발 환경)**:
   - 현재 코드는 Redis가 없어도 애널리스트 등록은 정상 동작합니다
   - 에러는 로그에만 기록되고 애널리스트 등록은 성공합니다
   - 데이터 수집은 나중에 수동으로 시작할 수 있습니다

2. **Redis 설치 및 실행 (선택사항)**:
   ```bash
   # Docker Compose 사용 시
   docker-compose up -d redis
   
   # 로컬 설치 (macOS)
   brew install redis
   brew services start redis
   
   # 로컬 설치 (Linux)
   sudo apt-get install redis-server
   sudo systemctl start redis
   ```

**참고**:
- Redis/Celery는 비동기 작업(데이터 수집)에만 사용됩니다
- 애널리스트 등록 자체는 Redis 없이도 정상 동작합니다
- 프로덕션 환경에서는 Redis 사용을 권장합니다

## 다음 단계

데이터 등록 후:
1. ✅ 애널리스트 목록 확인
2. ✅ 각 애널리스트 상세 정보 확인
3. ✅ 데이터 수집 작업 확인 (자동 시작됨)
4. ✅ 리포트 업로드 및 평가 진행

