# 비즈니스 로직 분석 보고서

## 개요

애널리스트 리포트 평가 시스템의 비즈니스 로직을 분석하고, 요구사항 대비 현재 구현 상태를 확인합니다.

## 비즈니스 요구사항

1. **애널리스트는 리포트를 PDF로 업로드**
2. **시스템은 PDF 내용을 평가 대상 기준 데이터로 사용**
3. **시스템은 리포트에서 추출한 기업명을 별도로 저장**
4. **해당 기업에 관련된 자료를 수집**
5. **KPI 평가식은 있지만 근거 데이터가 없는 상태**
6. **KPI 평가에 필요한 정보들을 웹 검색, DART API, KRX API 등으로 수집**

## 현재 구현 상태 분석

### 1. 리포트 업로드 및 파싱 ✅

**구현 위치**: `apps/api/app/services/report_service.py`, `apps/api/app/services/ai_agents/report_parsing_agent.py`

**현재 구현**:
- ✅ PDF 파일 업로드 및 저장 (`ReportService.upload_and_extract()`)
- ✅ PDF 내용 추출 (텍스트, 표, 이미지) (`DocumentExtractionService`)
- ✅ LLM 기반 섹션 구조화 (`ReportParsingAgent._extract_sections()`)
- ✅ 추출된 데이터 DB 저장 (`ReportParsingAgent._save_extracted_data()`)

**흐름**:
```
1. 사용자가 PDF 업로드 (analyst_id, company_id 선택 가능)
2. 파일 저장 및 Report 레코드 생성
3. BackgroundTasks로 비동기 파싱 시작
4. DocumentExtractionService로 텍스트/표/이미지 추출
5. ReportParsingAgent로 섹션 구조화
6. ExtractedText, ExtractedTable, ExtractedImage, ReportSection 저장
```

**문제점**:
- ⚠️ **기업명 자동 추출 미구현**: 업로드 시 `company_id`를 수동으로 선택해야 함
- ⚠️ PDF에서 기업명을 자동으로 추출하는 로직이 없음

### 2. 기업명 추출 및 저장 ⚠️

**구현 위치**: `apps/api/app/services/report_service.py`

**현재 구현**:
- ✅ 업로드 시 `company_id`를 받아서 저장
- ✅ `batch_upload_pdfs.py`에서 파일명으로 기업명 추출 (스크립트용)

**문제점**:
- ❌ **PDF 내용에서 기업명 자동 추출 미구현**
- ❌ 리포트 파싱 시 기업명을 자동으로 인식하고 Company 레코드를 생성/매칭하는 로직 없음
- ⚠️ 현재는 사용자가 수동으로 기업을 선택해야 함

**필요한 개선**:
```python
# ReportParsingAgent에 추가 필요
async def _extract_company_name(self, extraction_result: Dict) -> Optional[str]:
    """PDF에서 기업명 추출"""
    # 1. 텍스트에서 기업명 패턴 찾기
    # 2. LLM을 사용하여 기업명 추출
    # 3. Company 테이블에서 매칭 또는 생성
```

### 3. 기업 관련 자료 수집 ✅

**구현 위치**: `apps/api/app/services/data_collection_service.py`, `apps/api/app/services/ai_agents/data_collection_agent.py`

**현재 구현**:
- ✅ `DataCollectionService.start_collection()`: 데이터 수집 작업 시작
- ✅ `DataCollectionAgent.collect_data()`: Perplexity API로 웹 검색
- ✅ `DartService`: OpenDART API로 기업 실적 데이터 수집
- ✅ `KrxService`: KRX API로 주가 데이터 수집

**수집 타입**:
- `target_price`: 목표주가 관련 데이터
- `performance`: 실적 관련 데이터
- `sns`: SNS 주목도 데이터
- `media`: 미디어 언급 빈도 데이터

**흐름**:
```
1. 사용자가 데이터 수집 시작 (analyst_id, collection_types, 기간)
2. CollectionJob 생성
3. Celery 태스크로 비동기 수집 시작
4. DataCollectionAgent가 각 타입별로 데이터 수집
5. Perplexity API로 웹 검색
6. DataCollectionLog에 결과 저장
```

**문제점**:
- ⚠️ 리포트 업로드 후 자동으로 기업 관련 자료 수집이 시작되지 않음
- ⚠️ 리포트에서 추출한 기업명을 기반으로 자동 수집하는 로직 없음

### 4. KPI 평가 및 근거 데이터 수집 ✅

**구현 위치**: `apps/api/app/services/ai_agents/evaluation_agent.py`

**현재 구현**:
- ✅ `EvaluationAgent.evaluate_async()`: 평가 프로세스 실행
- ✅ `_extract_predictions()`: 리포트에서 예측 정보 추출
- ✅ `_collect_actual_data()`: 실제 데이터 수집 (DART, KRX, Perplexity 통합)
- ✅ `_calculate_accuracy()`: 정확도 계산
- ✅ `_calculate_scores()`: 7개 KPI 점수 계산

**KPI 평가 흐름**:
```
1. 리포트에서 예측 정보 추출 (목표주가, 실적 예측 등)
2. 실제 데이터 수집:
   - 목표주가 → KRX API로 실제 주가 데이터
   - 실적 예측 → OpenDART API로 재무제표 데이터
   - 기타 → Perplexity API로 웹 검색
3. 예측 vs 실제 비교하여 정확도 계산
4. 7개 KPI 점수 계산:
   - target_price_accuracy (25%)
   - performance_accuracy (30%)
   - investment_logic_validity (15%)
   - risk_analysis_appropriateness (10%)
   - report_frequency (5%)
   - sns_attention (10%)
   - media_frequency (5%)
5. 가중치 적용하여 최종 점수 계산
6. EvaluationScore 저장
7. 스코어카드 자동 생성
```

**실제 데이터 수집 로직**:
- ✅ `_collect_target_price_actual()`: KRX API로 주가 데이터 수집
- ✅ `_collect_performance_actual()`: OpenDART API로 재무제표 데이터 수집
- ✅ `_collect_other_actual()`: Perplexity API로 기타 데이터 수집

**문제점**:
- ⚠️ `_extract_predictions()`가 실제로 예측을 추출하지 않음 (TODO 주석만 있음)
- ⚠️ 리포트 파싱 시 Prediction 레코드가 자동으로 생성되지 않음

## 주요 문제점 및 개선 필요 사항

### 1. 기업명 자동 추출 미구현 ❌

**현재 상태**:
- 리포트 업로드 시 사용자가 수동으로 기업을 선택해야 함
- PDF 내용에서 기업명을 자동으로 추출하는 로직 없음

**필요한 개선**:
```python
# ReportParsingAgent에 추가
async def _extract_company_name(self, extraction_result: Dict) -> Optional[str]:
    """PDF에서 기업명 추출"""
    # 1. 텍스트에서 기업명 패턴 찾기 (예: "삼성전자", "SK하이닉스" 등)
    # 2. LLM을 사용하여 기업명 추출
    # 3. Company 테이블에서 매칭 또는 생성
    # 4. Report.company_id 업데이트
```

### 2. 예측 정보 자동 추출 미구현 ⚠️

**현재 상태**:
- `_extract_predictions()` 메서드가 실제로 예측을 추출하지 않음
- 리포트 파싱 시 Prediction 레코드가 자동으로 생성되지 않음

**필요한 개선**:
```python
# ReportParsingAgent에 추가
async def _extract_predictions(self, report_id: UUID) -> List[Prediction]:
    """리포트에서 예측 정보 추출"""
    # 1. 추출된 텍스트에서 목표주가, 실적 예측 찾기
    # 2. LLM을 사용하여 구조화된 예측 정보 추출
    # 3. Prediction 레코드 생성 및 저장
```

### 3. 리포트 업로드 후 자동 데이터 수집 미구현 ⚠️

**현재 상태**:
- 리포트 업로드 후 자동으로 기업 관련 자료 수집이 시작되지 않음
- 사용자가 수동으로 데이터 수집을 시작해야 함

**필요한 개선**:
```python
# ReportService에 추가
async def upload_and_extract(...):
    # ... 기존 로직 ...
    
    # 리포트 파싱 완료 후 자동으로 데이터 수집 시작
    if report.company_id:
        background_tasks.add_task(
            self._start_auto_collection,
            report_id,
            report.company_id
        )
```

### 4. 데이터 수집과 평가 프로세스 연동 부족 ⚠️

**현재 상태**:
- 데이터 수집과 평가가 별도 프로세스로 동작
- 평가 시점에 필요한 데이터가 이미 수집되어 있는지 확인하지 않음

**필요한 개선**:
```python
# EvaluationAgent에 추가
async def evaluate_async(...):
    # 1. 필요한 데이터가 수집되었는지 확인
    # 2. 없으면 자동으로 수집 시작
    # 3. 수집 완료 후 평가 진행
```

## 권장 개선 사항

### 우선순위 1: 기업명 자동 추출 구현

1. `ReportParsingAgent`에 `_extract_company_name()` 메서드 추가
2. LLM을 사용하여 PDF 텍스트에서 기업명 추출
3. Company 테이블에서 매칭 또는 자동 생성
4. Report.company_id 자동 업데이트

### 우선순위 2: 예측 정보 자동 추출 구현

1. `ReportParsingAgent`에 `_extract_predictions()` 메서드 구현
2. 추출된 텍스트에서 목표주가, 실적 예측 정보 추출
3. Prediction 레코드 자동 생성 및 저장

### 우선순위 3: 자동 데이터 수집 연동

1. 리포트 파싱 완료 후 자동으로 기업 관련 자료 수집 시작
2. 평가 시작 전 필요한 데이터 수집 완료 확인
3. 데이터 수집 완료 후 평가 자동 진행

## 현재 구현된 기능 요약

### ✅ 완전 구현된 기능

1. **리포트 업로드 및 파싱**
   - PDF 파일 업로드 및 저장
   - 텍스트, 표, 이미지 추출
   - 섹션 구조화 (LLM 기반)

2. **외부 API 통합**
   - OpenDART API (기업 실적 데이터)
   - KRX API (주가 데이터)
   - Perplexity API (웹 검색)

3. **KPI 평가 로직**
   - 7개 KPI 점수 계산
   - 실제 데이터 수집 및 정확도 계산
   - 가중치 적용 최종 점수 계산

4. **데이터 수집 서비스**
   - 수동 데이터 수집 시작
   - 수집 로그 관리
   - 수집 상태 추적

### ⚠️ 부분 구현된 기능

1. **기업명 추출**
   - 파일명 기반 추출 (스크립트용)
   - PDF 내용 기반 자동 추출 미구현

2. **예측 정보 추출**
   - 메서드는 있으나 실제 추출 로직 미구현

### ❌ 미구현 기능

1. **리포트 업로드 후 자동 데이터 수집**
2. **평가 전 데이터 수집 완료 확인**

## 결론

현재 시스템은 리포트 업로드, 파싱, 데이터 수집, KPI 평가의 기본 구조는 잘 구현되어 있습니다. 
하지만 **기업명 자동 추출**과 **예측 정보 자동 추출**이 미구현되어 있어, 
사용자가 수동으로 기업을 선택하고 예측 정보를 입력해야 하는 상황입니다.

**권장 사항**: 
1. 기업명 자동 추출 기능 구현 (우선순위 높음)
2. 예측 정보 자동 추출 기능 구현 (우선순위 높음)
3. 리포트 업로드 후 자동 데이터 수집 연동 (우선순위 중간)

