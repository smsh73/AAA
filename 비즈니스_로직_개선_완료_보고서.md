# 비즈니스 로직 개선 완료 보고서

## 개요

분석된 문제점을 개선하여 리포트 업로드부터 평가까지의 전체 프로세스를 자동화했습니다.

## 개선된 기능

### 1. 기업명 자동 추출 기능 ✅

**구현 위치**: `apps/api/app/services/ai_agents/report_parsing_agent.py`

**기능**:
- PDF 내용에서 기업명을 자동으로 추출
- LLM(GPT-4)을 사용하여 기업명, 종목코드, 영어 기업명 추출
- Company 테이블에서 매칭 또는 자동 생성
- 리포트의 `company_id` 자동 업데이트

**프로세스**:
1. 리포트 파싱 시 `company_id`가 없으면 자동 추출 시작
2. 추출된 텍스트에서 기업명 패턴 찾기
3. LLM을 사용하여 구조화된 기업 정보 추출
4. Company 테이블에서 종목코드 또는 기업명으로 검색
5. 없으면 새 Company 레코드 생성 (임시 ticker 포함)
6. 리포트의 `company_id` 업데이트

**UI 개선**:
- 리포트 업로드 페이지에 "자동 추출 시도" 안내 메시지 추가
- 리포트 상세 페이지에 추출된 기업명 표시

### 2. 예측 정보 자동 추출 기능 ✅

**구현 위치**: `apps/api/app/services/ai_agents/report_parsing_agent.py`

**기능**:
- 리포트에서 목표주가, 실적 예측 정보 자동 추출
- LLM(GPT-4)을 사용하여 구조화된 예측 정보 추출
- Prediction 레코드 자동 생성 및 저장

**추출되는 예측 타입**:
- `target_price`: 목표주가
- `revenue`: 매출액 예측
- `operating_profit`: 영업이익 예측
- `net_profit`: 당기순이익 예측

**프로세스**:
1. 리포트 파싱 시 예측 관련 섹션 우선 분석
2. LLM을 사용하여 예측 정보 추출
3. 각 예측에 대해 Prediction 레코드 생성
4. 예측 타입, 값, 단위, 기간, 근거 저장

**UI 개선**:
- 리포트 상세 페이지에 추출된 예측 정보 개수 표시
- 예측 정보 테이블에 자동 추출된 데이터 표시

### 3. 리포트 파싱 완료 후 자동 데이터 수집 연동 ✅

**구현 위치**: `apps/api/app/services/ai_agents/report_parsing_agent.py`

**기능**:
- 리포트 파싱 완료 후 자동으로 기업 관련 자료 수집 시작
- 목표주가, 실적, SNS, 언론 데이터 수집
- 최근 3개월 데이터 수집

**프로세스**:
1. 리포트 파싱 완료 후 `company_id` 확인
2. `DataCollectionService`를 사용하여 데이터 수집 시작
3. 수집 타입: `target_price`, `performance`, `sns`, `media`
4. 수집 기간: 리포트 발간일 기준 최근 3개월
5. 에러 발생해도 리포트 파싱은 완료된 것으로 처리

### 4. 백엔드 API 개선 ✅

**새로운 엔드포인트**:
- `GET /api/reports/{report_id}/extracted-company`: 추출된 기업 정보 조회

**개선된 엔드포인트**:
- `GET /api/reports/{report_id}`: 리포트 상세 조회 시 추출된 기업명과 예측 정보 개수 포함

**스키마 추가**:
- `CompanyExtractionResponse`: 기업명 추출 결과 스키마
- `ReportDetailResponse`: `extracted_company_name`, `predictions_count` 필드 추가

### 5. 데이터 모델 수정 ✅

**Company 모델**:
- `ticker` 필드를 `nullable=True`로 변경 (자동 추출 시 임시 값 가능)
- 임시 ticker 생성 로직 추가 (기업명 해시 기반)

**Prediction 모델**:
- 리포트 파싱 시 자동으로 생성되도록 개선

### 6. EvaluationAgent 개선 ✅

**변경 사항**:
- `_extract_predictions()` 메서드가 이미 추출된 Prediction을 사용하도록 수정
- 리포트 파싱 시 이미 Prediction이 생성되므로 조회만 수행

## UI/UX 개선 사항

### 리포트 업로드 페이지 (`apps/web/src/app/reports/upload/page.tsx`)

**개선 내용**:
- 기업 선택 드롭다운에 "선택 안 함 (자동 추출 시도)" 옵션 추가
- 자동 추출 안내 메시지 추가

### 리포트 상세 페이지 (`apps/web/src/app/reports/[id]/page.tsx`)

**개선 내용**:
- 추출된 기업명 표시 (자동 추출 표시)
- 추출된 예측 정보 개수 표시
- 예측 정보 테이블에 자동 추출된 데이터 표시

## 데이터 흐름

### 리포트 업로드 → 파싱 → 평가 전체 프로세스

```
1. 사용자가 PDF 리포트 업로드
   ↓
2. 리포트 저장 및 Report 레코드 생성
   ↓
3. BackgroundTasks로 비동기 파싱 시작
   ↓
4. DocumentExtractionService로 텍스트/표/이미지 추출
   ↓
5. ReportParsingAgent.parse_report() 실행
   ├─ 기업명 자동 추출 (company_id 없을 경우)
   ├─ 섹션 구조화
   ├─ 예측 정보 자동 추출
   └─ 추출된 데이터 저장
   ↓
6. 리포트 파싱 완료 후 자동 데이터 수집 시작
   ├─ 목표주가 데이터 수집 (KRX API)
   ├─ 실적 데이터 수집 (OpenDART API)
   ├─ SNS 주목도 데이터 수집 (Perplexity)
   └─ 언론 언급 빈도 데이터 수집 (Perplexity)
   ↓
7. 사용자가 평가 시작
   ↓
8. EvaluationAgent.evaluate_async() 실행
   ├─ 이미 추출된 Prediction 사용
   ├─ 실제 데이터 수집 (이미 수집된 데이터 사용)
   ├─ 정확도 계산
   ├─ 7개 KPI 점수 계산
   └─ 스코어카드 자동 생성
```

## 개선 효과

### 1. 사용자 편의성 향상
- 기업 선택이 선택사항이 되어 업로드 프로세스 간소화
- 자동 추출로 수동 입력 작업 감소

### 2. 데이터 정합성 향상
- 리포트 파싱 시 자동으로 기업명과 예측 정보 추출
- 평가 시 필요한 데이터가 이미 준비되어 있음

### 3. 프로세스 자동화
- 리포트 업로드 후 자동으로 데이터 수집 시작
- 평가 시작 전 필요한 데이터가 이미 수집되어 있음

### 4. 평가 정확도 향상
- 실제 데이터 기반 평가 가능
- 예측 정보가 자동으로 추출되어 정확도 계산 가능

## 향후 개선 사항

### TODO (정합성 점검 후 구현)

1. **예측 정보 추출 정확도 향상**
   - 다양한 리포트 형식에 대한 패턴 학습
   - 예측 값 파싱 정확도 개선

2. **기업명 추출 정확도 향상**
   - 기업명 매칭 알고리즘 개선
   - 종목코드 자동 매칭 기능 추가

3. **데이터 수집 품질 개선**
   - 수집된 데이터 검증 로직 추가
   - 데이터 수집 실패 시 재시도 로직

4. **UI/UX 개선**
   - 리포트 파싱 진행 상황 실시간 표시
   - 데이터 수집 진행 상황 표시
   - 추출된 정보 미리보기 기능

## 마이그레이션 필요 사항

### Company 모델 변경
- `ticker` 필드를 `nullable=True`로 변경
- 기존 데이터에 대한 마이그레이션 스크립트 필요

**마이그레이션 스크립트 예시**:
```sql
-- ticker를 nullable로 변경
ALTER TABLE companies ALTER COLUMN ticker DROP NOT NULL;
```

## 테스트 권장 사항

1. **기업명 자동 추출 테스트**
   - 다양한 리포트 형식으로 테스트
   - 기업명이 명확하지 않은 경우 처리 확인

2. **예측 정보 추출 테스트**
   - 다양한 예측 타입 포함 리포트로 테스트
   - 예측 값 파싱 정확도 확인

3. **자동 데이터 수집 테스트**
   - 리포트 파싱 완료 후 데이터 수집 시작 확인
   - 데이터 수집 실패 시 처리 확인

4. **전체 프로세스 통합 테스트**
   - 리포트 업로드 → 파싱 → 데이터 수집 → 평가 전체 프로세스 테스트

