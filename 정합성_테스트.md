# 정합성 테스트 가이드

## 개요

프론트엔드와 백엔드 간의 API 정합성을 검증하는 테스트 가이드입니다.

## 사전 준비

### 1. 환경 변수 설정

**프론트엔드** (`apps/web/.env.local`):
```bash
NEXT_PUBLIC_API_URL=http://localhost:8000
```

**백엔드** (프로젝트 루트 `.env`):
```bash
DATABASE_URL=postgresql://user:password@localhost:5432/analyst_awards
REDIS_URL=redis://localhost:6379/0
CORS_ORIGINS=http://localhost:3000
```

### 2. 서비스 시작

#### 백엔드 서버
```bash
cd apps/api
uvicorn app.main:app --reload --port 8000
```

#### 프론트엔드 서버
```bash
cd apps/web
npm run dev
```

## API 정합성 테스트

### 1. Health Check

**엔드포인트**: `GET /api/health`

**예상 응답**:
```json
{
  "status": "ok",
  "timestamp": "2025-01-16T12:00:00Z"
}
```

**테스트 명령**:
```bash
curl http://localhost:8000/api/health
```

### 2. Dashboard API

#### 2.1 통계 조회
**엔드포인트**: `GET /api/dashboard/stats`

**예상 응답**:
```json
{
  "total_reports": 0,
  "total_evaluations": 0,
  "total_awards": 0,
  "total_analysts": 0,
  "recent_evaluations_count": 0,
  "pending_evaluations_count": 0
}
```

**테스트 명령**:
```bash
curl http://localhost:8000/api/dashboard/stats
```

#### 2.2 최근 평가 조회
**엔드포인트**: `GET /api/dashboard/recent-evaluations?limit=10`

**예상 응답**:
```json
{
  "evaluations": [],
  "total": 0
}
```

#### 2.3 어워드 현황
**엔드포인트**: `GET /api/dashboard/award-status`

**예상 응답**:
```json
{
  "awards_by_category": [],
  "total_awards": 0,
  "period": "2025-Q1"
}
```

### 3. Analysts API

#### 3.1 목록 조회
**엔드포인트**: `GET /api/analysts`

**예상 응답**:
```json
[]
```

**테스트 명령**:
```bash
curl http://localhost:8000/api/analysts
```

#### 3.2 생성
**엔드포인트**: `POST /api/analysts`

**요청 본문**:
```json
{
  "name": "홍길동",
  "firm": "삼성증권",
  "department": "리서치센터",
  "sector": "반도체"
}
```

**테스트 명령**:
```bash
curl -X POST http://localhost:8000/api/analysts \
  -H "Content-Type: application/json" \
  -d '{
    "name": "홍길동",
    "firm": "삼성증권",
    "department": "리서치센터",
    "sector": "반도체"
  }'
```

#### 3.3 상세 조회
**엔드포인트**: `GET /api/analysts/{analyst_id}`

#### 3.4 수정
**엔드포인트**: `PUT /api/analysts/{analyst_id}`

**요청 본문**:
```json
{
  "name": "홍길동",
  "firm": "KB증권"
}
```

#### 3.5 삭제
**엔드포인트**: `DELETE /api/analysts/{analyst_id}`

#### 3.6 일괄 등록
**엔드포인트**: `POST /api/analysts/bulk-import`

**요청**: multipart/form-data (Excel 파일)

### 4. Companies API

#### 4.1 목록 조회
**엔드포인트**: `GET /api/companies`

#### 4.2 상세 조회
**엔드포인트**: `GET /api/companies/{company_id}`

### 5. Reports API

#### 5.1 목록 조회
**엔드포인트**: `GET /api/reports?skip=0&limit=20`

**예상 응답**:
```json
{
  "reports": [],
  "total": 0,
  "skip": 0,
  "limit": 20
}
```

#### 5.2 상세 조회
**엔드포인트**: `GET /api/reports/{report_id}`

#### 5.3 업로드
**엔드포인트**: `POST /api/reports/upload`

**요청**: multipart/form-data (PDF 파일)

#### 5.4 예측 정보 조회
**엔드포인트**: `GET /api/reports/{report_id}/predictions`

### 6. Evaluations API

#### 6.1 목록 조회
**엔드포인트**: `GET /api/evaluations?skip=0&limit=20`

**예상 응답**:
```json
{
  "evaluations": [],
  "total": 0,
  "skip": 0,
  "limit": 20
}
```

#### 6.2 평가 시작
**엔드포인트**: `POST /api/evaluations/start`

**요청 본문**:
```json
{
  "report_id": "uuid"
}
```

#### 6.3 상세 조회
**엔드포인트**: `GET /api/evaluations/{evaluation_id}`

#### 6.4 점수 조회
**엔드포인트**: `GET /api/evaluations/{evaluation_id}/scores`

### 7. Scorecards API

#### 7.1 목록 조회
**엔드포인트**: `GET /api/scorecards?period=2025-Q1`

#### 7.2 상세 조회
**엔드포인트**: `GET /api/scorecards/{scorecard_id}`

#### 7.3 랭킹 조회
**엔드포인트**: `GET /api/scorecards/ranking?period=2025-Q1&limit=100`

### 8. Scores API

#### 8.1 스코어 조회
**엔드포인트**: `GET /api/scores?analyst_id={id}&period=2025-Q1`

#### 8.2 스코어 재계산
**엔드포인트**: `POST /api/scores/recompute`

**요청 본문**:
```json
{
  "analyst_id": "uuid",
  "period": "2025-Q1",
  "force": false
}
```

### 9. Awards API

#### 9.1 목록 조회
**엔드포인트**: `GET /api/awards?year=2025`

#### 9.2 어워드 실행
**엔드포인트**: `POST /api/awards/run?year=2025&quarter=1`

### 10. Data Collection API

#### 10.1 수집 시작
**엔드포인트**: `POST /api/data-collection/start`

**요청 본문**:
```json
{
  "analyst_id": "uuid",
  "collection_types": ["target_price", "performance"],
  "start_date": "2025-01-01",
  "end_date": "2025-01-31"
}
```

#### 10.2 상태 조회
**엔드포인트**: `GET /api/data-collection/{job_id}/status`

#### 10.3 로그 조회
**엔드포인트**: `GET /api/data-collection/logs?limit=100`

### 11. Agents API

#### 11.1 상태 조회
**엔드포인트**: `GET /api/agents/status`

**예상 응답**:
```json
{
  "agents": [
    {
      "name": "evaluation",
      "status": "active",
      "description": "평가 에이전트"
    }
  ]
}
```

#### 11.2 평가 에이전트 실행
**엔드포인트**: `POST /api/agents/evaluation/run`

**요청 본문**:
```json
{
  "analyst_id": "uuid",
  "period": "2025-Q1",
  "metrics": []
}
```

## 프론트엔드-백엔드 매칭 검증

### 1. API 엔드포인트 매칭

| 프론트엔드 호출 | 백엔드 엔드포인트 | 상태 |
|----------------|-----------------|------|
| `GET /api/dashboard/stats` | `GET /api/dashboard/stats` | ✅ |
| `GET /api/dashboard/recent-evaluations` | `GET /api/dashboard/recent-evaluations` | ✅ |
| `GET /api/dashboard/award-status` | `GET /api/dashboard/award-status` | ✅ |
| `GET /api/analysts` | `GET /api/analysts` | ✅ |
| `POST /api/analysts` | `POST /api/analysts` | ✅ |
| `GET /api/analysts/{id}` | `GET /api/analysts/{id}` | ✅ |
| `PUT /api/analysts/{id}` | `PUT /api/analysts/{id}` | ✅ |
| `DELETE /api/analysts/{id}` | `DELETE /api/analysts/{id}` | ✅ |
| `POST /api/analysts/bulk-import` | `POST /api/analysts/bulk-import` | ✅ |
| `GET /api/companies` | `GET /api/companies` | ✅ |
| `GET /api/companies/{id}` | `GET /api/companies/{id}` | ✅ |
| `GET /api/reports` | `GET /api/reports` | ✅ |
| `GET /api/reports/{id}` | `GET /api/reports/{id}` | ✅ |
| `POST /api/reports/upload` | `POST /api/reports/upload` | ✅ |
| `GET /api/reports/{id}/predictions` | `GET /api/reports/{id}/predictions` | ✅ |
| `GET /api/evaluations` | `GET /api/evaluations` | ✅ |
| `POST /api/evaluations/start` | `POST /api/evaluations/start` | ✅ |
| `GET /api/evaluations/{id}` | `GET /api/evaluations/{id}` | ✅ |
| `GET /api/evaluations/{id}/scores` | `GET /api/evaluations/{id}/scores` | ✅ |
| `GET /api/scorecards` | `GET /api/scorecards` | ✅ |
| `GET /api/scorecards/{id}` | `GET /api/scorecards/{id}` | ✅ |
| `GET /api/scorecards/ranking` | `GET /api/scorecards/ranking` | ✅ |
| `GET /api/awards` | `GET /api/awards` | ✅ |
| `POST /api/data-collection/start` | `POST /api/data-collection/start` | ✅ |
| `GET /api/data-collection/{id}/status` | `GET /api/data-collection/{id}/status` | ✅ |
| `GET /api/data-collection/logs` | `GET /api/data-collection/logs` | ✅ |
| `GET /api/agents/status` | `GET /api/agents/status` | ✅ |

### 2. 스키마 검증

모든 API 응답이 정의된 Pydantic 스키마와 일치하는지 확인:

- ✅ `DashboardStatsResponse`
- ✅ `RecentEvaluationsResponse`
- ✅ `AwardStatusResponse`
- ✅ `AnalystResponse`
- ✅ `CompanyResponse`
- ✅ `ReportResponse`
- ✅ `EvaluationResponse`
- ✅ `ScorecardResponse`
- ✅ `AwardResponse`
- ✅ `DataCollectionStartResponse`
- ✅ `DataCollectionStatusResponse`
- ✅ `DataCollectionLogResponse`

## 자동화된 테스트 스크립트

### Python 테스트 스크립트

`apps/api/tests/test_api_integration.py` 파일을 생성하여 자동화된 테스트를 작성할 수 있습니다.

## 테스트 체크리스트

- [ ] Health Check API 정상 응답
- [ ] Dashboard API 정상 응답
- [ ] Analysts CRUD API 정상 동작
- [ ] Companies API 정상 응답
- [ ] Reports API 정상 응답
- [ ] Evaluations API 정상 응답
- [ ] Scorecards API 정상 응답
- [ ] Scores API 정상 응답
- [ ] Awards API 정상 응답
- [ ] Data Collection API 정상 응답
- [ ] Agents API 정상 응답
- [ ] 프론트엔드 페이지에서 모든 API 호출 정상 동작
- [ ] 스키마 일치 확인
- [ ] 에러 처리 확인

