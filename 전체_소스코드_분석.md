# 전체 소스코드 분석 문서

## 목차

1. [프로젝트 개요](#프로젝트-개요)
2. [프로젝트 구조](#프로젝트-구조)
3. [기술 스택](#기술-스택)
4. [백엔드 아키텍처](#백엔드-아키텍처)
5. [프론트엔드 아키텍처](#프론트엔드-아키텍처)
6. [데이터베이스 스키마](#데이터베이스-스키마)
7. [주요 기능 모듈](#주요-기능-모듈)
8. [API 엔드포인트](#api-엔드포인트)
9. [AI 에이전트 시스템](#ai-에이전트-시스템)
10. [비동기 작업 처리](#비동기-작업-처리)
11. [데이터 흐름](#데이터-흐름)

## 프로젝트 개요

**프로젝트명**: AI가 찾은 스타 애널리스트 어워즈 시스템

**목적**: AI 기반으로 증권사 애널리스트의 리포트를 분석하고 평가하여 최고의 애널리스트를 선정하는 시스템

**핵심 기능**:
- 애널리스트 리포트 업로드 및 파싱
- AI 기반 정량 분석 (목표주가 정확도, 실적 예측 정확도 등)
- SNS 및 시장 반응 분석
- 전문가 평가 및 설문 관리
- 통합 스코어링 및 랭킹
- 어워드 선정

## 프로젝트 구조

```
AAA 2/
├── apps/
│   ├── api/                    # FastAPI 백엔드
│   │   ├── alembic/           # 데이터베이스 마이그레이션
│   │   ├── app/
│   │   │   ├── models/        # SQLAlchemy 모델 (18개)
│   │   │   ├── routers/       # API 라우터 (10개)
│   │   │   ├── schemas/       # Pydantic 스키마
│   │   │   ├── services/      # 비즈니스 로직 서비스
│   │   │   │   └── ai_agents/ # AI 에이전트 (11개)
│   │   │   ├── tasks/         # Celery 태스크
│   │   │   ├── main.py        # FastAPI 앱 진입점
│   │   │   ├── database.py    # DB 설정
│   │   │   └── celery_app.py # Celery 설정
│   │   ├── requirements.txt   # Python 의존성
│   │   └── alembic.ini        # Alembic 설정
│   │
│   └── web/                    # Next.js 프론트엔드
│       ├── src/
│       │   ├── app/           # Next.js App Router 페이지
│       │   ├── components/    # React 컴포넌트
│       │   ├── lib/          # 유틸리티 (API 클라이언트)
│       │   └── styles/       # CSS 스타일
│       ├── package.json
│       └── next.config.js
│
├── docker-compose.yml          # Docker Compose 설정
├── Dockerfile                  # Docker 이미지 설정
├── pyproject.toml              # Python 프로젝트 설정
├── package.json                # 루트 패키지 설정
└── README.md                   # 프로젝트 문서
```

## 기술 스택

### 백엔드 (Python)

**웹 프레임워크**:
- FastAPI 0.104.1
- Uvicorn 0.24.0

**데이터베이스**:
- PostgreSQL (SQLAlchemy 2.0.23)
- Alembic 1.12.1 (마이그레이션)
- psycopg2-binary 2.9.9

**비동기 작업**:
- Celery 5.3.4
- Redis 5.0.1

**AI/ML**:
- OpenAI SDK 1.3.5 (GPT-4)
- Anthropic SDK 0.7.7 (Claude 3.5 Sonnet)
- Google Generative AI 0.3.1 (Gemini Pro)
- Perplexity API (실시간 검색)

**문서 처리**:
- pdfplumber 0.10.3
- PyPDF2 3.0.1
- PaddleOCR 2.7.0.3
- pdf2image 1.16.3
- Pillow 10.1.0

**기타**:
- Pydantic 2.5.0 (데이터 검증)
- httpx 0.25.2 (HTTP 클라이언트)
- pandas 2.1.3, numpy 1.26.2 (데이터 처리)
- openpyxl 3.1.2 (Excel 처리)

### 프론트엔드 (TypeScript/React)

**프레임워크**:
- Next.js 14.0.0
- React 18.2.0
- TypeScript 5.2.0

**상태 관리**:
- @tanstack/react-query 5.0.0

**HTTP 클라이언트**:
- axios 1.6.0

**스타일링**:
- TailwindCSS 3.3.0
- PostCSS 8.4.0

**차트/시각화**:
- recharts 2.10.0

**기타**:
- date-fns 2.30.0 (날짜 처리)
- clsx 2.0.0 (클래스 유틸리티)

### 인프라

- Docker & Docker Compose
- PostgreSQL 14
- Redis 7

## 백엔드 아키텍처

### 계층 구조

```
┌─────────────────────────────────────┐
│      API Layer (FastAPI)            │
│      - Routers (10개)               │
│      - Schemas (Pydantic)           │
│      - Request/Response 처리         │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      Service Layer                  │
│      - Business Logic               │
│      - AI Agents (11개)             │
│      - LLM Service                  │
│      - Document Extraction          │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      Data Layer                     │
│      - SQLAlchemy Models (18개)     │
│      - Database Session              │
│      - Alembic Migrations            │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      Infrastructure                 │
│      - PostgreSQL                    │
│      - Redis                         │
│      - Celery Workers                │
└──────────────────────────────────────┘
```

### 라우터 (10개)

1. **health.py**: 헬스 체크
2. **dashboard.py**: 대시보드 통계
3. **analysts.py**: 애널리스트 관리
   - GET `/api/analysts` - 목록 조회
   - GET `/api/analysts/{id}` - 상세 조회
   - POST `/api/analysts` - 생성
   - POST `/api/analysts/bulk-import` - 일괄 등록
4. **reports.py**: 리포트 관리
   - GET `/api/reports` - 목록 조회
   - GET `/api/reports/{id}` - 상세 조회
   - POST `/api/reports/upload` - 업로드
5. **companies.py**: 기업 관리
6. **evaluations.py**: 평가 관리
   - POST `/api/evaluations/start` - 평가 시작
   - GET `/api/evaluations/{id}` - 평가 결과
7. **scorecards.py**: 스코어카드 관리
8. **awards.py**: 어워드 관리
   - GET `/api/awards` - 어워드 조회
   - POST `/api/awards/run` - 어워드 선정 실행
9. **data_collection.py**: 데이터 수집
   - POST `/api/data-collection/start` - 수집 시작
   - GET `/api/data-collection/{job_id}/status` - 상태 조회
   - GET `/api/data-collection/logs` - 로그 조회
10. **evaluation_reports.py**: 평가 보고서

### 서비스 (13개)

1. **analyst_service.py**: 애널리스트 비즈니스 로직
2. **report_service.py**: 리포트 업로드 및 파싱
3. **company_service.py**: 기업 정보 관리
4. **evaluation_service.py**: 평가 프로세스 관리
5. **scorecard_service.py**: 스코어카드 생성
6. **award_service.py**: 어워드 선정 로직
7. **data_collection_service.py**: 데이터 수집 관리
8. **evaluation_report_service.py**: 평가 보고서 생성
9. **document_extraction_service.py**: PDF 문서 추출
10. **llm_service.py**: 통합 LLM 서비스
11. **perplexity_service.py**: Perplexity API 클라이언트
12. **excel_parser.py**: Excel 파일 파싱

### AI 에이전트 (11개)

1. **evaluation_agent.py**: 평가 실행
2. **award_agent.py**: 어워드 선정
3. **report_generation_agent.py**: 상세 보고서 생성
4. **report_parsing_agent.py**: 리포트 파싱
5. **company_verification_agent.py**: 기업정보 검증
6. **performance_verification_agent.py**: 실적 검증
7. **stock_tracking_agent.py**: 추천종목 추적
8. **data_collection_agent.py**: 데이터 수집
9. **orchestrator_agent.py**: 멀티 LLM 오케스트레이션
10. **portfolio_analysis_agent.py**: 포트폴리오 분석
11. **analyst_report_agent.py**: 리포트 AI 분석

### Celery 태스크 (4개)

1. **report_tasks.py**: 리포트 파싱 작업
2. **evaluation_tasks.py**: 평가 작업
3. **data_collection_tasks.py**: 데이터 수집 작업
4. **award_tasks.py**: 어워드 선정 작업

## 프론트엔드 아키텍처

### 페이지 구조 (Next.js App Router)

```
src/app/
├── page.tsx                    # 홈 페이지
├── layout.tsx                  # 레이아웃
├── globals.css                 # 전역 스타일
│
├── dashboard/
│   └── page.tsx               # 대시보드
│
├── analysts/
│   ├── page.tsx               # 애널리스트 목록
│   └── [id]/
│       └── page.tsx           # 애널리스트 상세
│
├── reports/
│   ├── page.tsx               # 리포트 목록
│   ├── [id]/
│   │   └── page.tsx           # 리포트 상세
│   └── upload/
│       └── page.tsx           # 리포트 업로드
│
├── evaluations/
│   ├── page.tsx               # 평가 목록
│   └── [id]/
│       └── page.tsx           # 평가 상세
│
├── scorecards/
│   ├── page.tsx               # 스코어카드 목록
│   ├── [id]/
│   │   └── page.tsx           # 스코어카드 상세
│   └── ranking/
│       └── page.tsx           # 랭킹
│
├── awards/
│   └── page.tsx               # 어워드
│
└── data-collection/
    └── page.tsx               # 데이터 수집 관리
```

### 컴포넌트 구조

```
src/components/
├── Layout/
│   ├── Layout.tsx             # 메인 레이아웃
│   └── Navbar.tsx             # 네비게이션 바
│
├── UI/
│   ├── Button.tsx             # 버튼 컴포넌트
│   ├── Card.tsx               # 카드 컴포넌트
│   └── Table.tsx              # 테이블 컴포넌트
│
└── Charts/
    ├── BarChart.tsx           # 막대 차트
    ├── LineChart.tsx          # 선 차트
    └── RadarChart.tsx         # 레이더 차트
```

### API 클라이언트

```typescript
// src/lib/api.ts
- axios 인스턴스 생성
- baseURL: process.env.NEXT_PUBLIC_API_URL
- 기본 헤더 설정
```

## 데이터베이스 스키마

### 테이블 구조 (18개)

#### 기본 엔티티 (3개)
1. **analysts**: 애널리스트 정보
2. **companies**: 기업 정보
3. **markets**: 시장 정보

#### 리포트 관련 (5개)
4. **reports**: 리포트 메타데이터
5. **report_sections**: 리포트 섹션
6. **extracted_texts**: 추출된 텍스트
7. **extracted_tables**: 추출된 표
8. **extracted_images**: 추출된 이미지

#### 예측 및 결과 (2개)
9. **predictions**: 예측 정보
10. **actual_results**: 실제 결과

#### 평가 관련 (3개)
11. **evaluations**: 평가 메인
12. **evaluation_scores**: 평가 점수 상세
13. **evaluation_reports**: 평가 보고서

#### 스코어카드 및 수상 (2개)
14. **scorecards**: 스코어카드
15. **awards**: 수상 내역

#### 데이터 수집 (3개)
16. **data_sources**: 데이터 소스
17. **data_collection_logs**: 수집 로그
18. **collection_jobs**: 수집 작업

#### 템플릿 (1개)
19. **prompt_templates**: 프롬프트 템플릿

### 주요 관계

- `analysts` 1:N `reports`
- `analysts` 1:N `evaluations`
- `analysts` 1:N `scorecards`
- `analysts` 1:N `collection_jobs`
- `companies` 1:N `reports`
- `companies` 1:N `predictions`
- `reports` 1:N `predictions`
- `predictions` 1:N `actual_results`
- `evaluations` 1:1 `evaluation_reports`
- `evaluations` 1:N `evaluation_scores`
- `scorecards` 1:N `awards`
- `collection_jobs` 1:N `data_collection_logs`

## 주요 기능 모듈

### 1. 리포트 업로드 및 파싱

**프로세스**:
1. 사용자가 PDF 리포트 업로드
2. `DocumentExtractionService`가 PDF 파싱
3. `ReportParsingAgent`가 섹션 추출
4. 텍스트, 표, 이미지 추출
5. 리포트 메타데이터 저장

**주요 파일**:
- `routers/reports.py`
- `services/report_service.py`
- `services/document_extraction_service.py`
- `services/ai_agents/report_parsing_agent.py`
- `tasks/report_tasks.py`

### 2. 데이터 수집

**프로세스**:
1. 사용자가 수집 작업 시작 (애널리스트, 타입, 기간 선택)
2. `CollectionJob` 생성
3. Celery 태스크로 비동기 실행
4. `DataCollectionAgent`가 Perplexity API로 데이터 수집
5. 수집된 데이터를 `DataCollectionLog`에 저장
6. 진행 상황 실시간 업데이트

**수집 타입**:
- `target_price`: 목표주가 데이터
- `performance`: 실적 데이터
- `sns`: SNS 반응 데이터
- `media`: 언론 보도 데이터

**주요 파일**:
- `routers/data_collection.py`
- `services/data_collection_service.py`
- `services/ai_agents/data_collection_agent.py`
- `tasks/data_collection_tasks.py`
- `models/collection_job.py`
- `models/data_collection_log.py`

### 3. 평가 프로세스

**프로세스**:
1. 평가 시작 요청
2. `EvaluationAgent` 실행
3. 1단계: AI 정량 분석
   - 목표주가 정확도
   - 실적 예측 정확도
   - 추천종목 추적
4. 2단계: SNS·시장 반응 분석
   - SNS 언급량 및 감정 분석
   - 언론 보도 분석
5. 3단계: 전문가 평가 (수동 입력)
6. 통합 점수 계산
7. 스코어카드 생성

**주요 파일**:
- `routers/evaluations.py`
- `services/evaluation_service.py`
- `services/ai_agents/evaluation_agent.py`
- `services/ai_agents/performance_verification_agent.py`
- `services/ai_agents/stock_tracking_agent.py`
- `tasks/evaluation_tasks.py`

### 4. 어워드 선정

**프로세스**:
1. 어워드 선정 실행
2. `AwardAgent`가 스코어카드 분석
3. 카테고리별 랭킹 생성
4. Gold, Silver, Bronze 선정
5. 어워드 저장

**주요 파일**:
- `routers/awards.py`
- `services/award_service.py`
- `services/ai_agents/award_agent.py`
- `tasks/award_tasks.py`

### 5. LLM 통합

**LLM 서비스**:
- `LLMService`: 통합 LLM 서비스
  - OpenAI GPT-4
  - Claude 3.5 Sonnet
  - Gemini Pro
- `PerplexityService`: Perplexity API 클라이언트

**역할 분담**:
- **GPT-4**: 리포트 파싱, 추론, 구조화
- **Claude 3.5**: 장문 분석, 근거 검증, 상세 분석 작성
- **Gemini Pro**: 수치 검증, 차트 분석, 멀티모달 처리
- **Perplexity**: 실시간 데이터 수집, 팩트 체킹

**주요 파일**:
- `services/llm_service.py`
- `services/perplexity_service.py`
- `services/ai_agents/orchestrator_agent.py`

## API 엔드포인트

### 애널리스트

- `GET /api/analysts` - 목록 조회
- `GET /api/analysts/{id}` - 상세 조회
- `POST /api/analysts` - 생성
- `POST /api/analysts/bulk-import` - 일괄 등록 (Excel)

### 리포트

- `GET /api/reports` - 목록 조회
- `GET /api/reports/{id}` - 상세 조회
- `POST /api/reports/upload` - 업로드
- `GET /api/reports/{id}/predictions` - 예측 정보 조회

### 평가

- `POST /api/evaluations/start` - 평가 시작
- `GET /api/evaluations/{id}` - 평가 결과 조회
- `GET /api/evaluations` - 목록 조회

### 스코어카드

- `GET /api/scorecards` - 목록 조회
- `GET /api/scorecards/{id}` - 상세 조회
- `GET /api/scorecards/ranking` - 랭킹 조회

### 어워드

- `GET /api/awards` - 어워드 조회
- `POST /api/awards/run` - 어워드 선정 실행

### 데이터 수집

- `POST /api/data-collection/start` - 수집 시작
- `GET /api/data-collection/{job_id}/status` - 상태 조회
- `GET /api/data-collection/logs` - 로그 조회
- `GET /api/data-collection/analysts/{id}/logs` - 애널리스트별 로그

### 대시보드

- `GET /api/dashboard/stats` - 통계 조회

## AI 에이전트 시스템

### 에이전트별 역할

1. **EvaluationAgent**
   - 평가 프로세스 전체 오케스트레이션
   - 각 단계별 에이전트 호출
   - 최종 점수 계산

2. **AwardAgent**
   - 스코어카드 분석
   - 카테고리별 랭킹 생성
   - 어워드 선정 로직

3. **ReportGenerationAgent**
   - 상세 평가 보고서 생성
   - LLM을 활용한 자연어 생성

4. **ReportParsingAgent**
   - 리포트 섹션 추출
   - 구조화된 데이터 변환

5. **CompanyVerificationAgent**
   - 기업 정보 검증
   - 외부 데이터 소스와 비교

6. **PerformanceVerificationAgent**
   - 실적 예측 정확도 검증
   - 실제 결과와 비교

7. **StockTrackingAgent**
   - 추천종목 추적
   - 목표주가 달성 여부 확인

8. **DataCollectionAgent**
   - Perplexity API를 통한 데이터 수집
   - 프롬프트 템플릿 활용

9. **OrchestratorAgent**
   - 멀티 LLM 오케스트레이션
   - LLM별 최적 작업 분배

10. **PortfolioAnalysisAgent**
    - 포트폴리오 분석
    - 종목별 성과 평가

11. **AnalystReportAgent**
    - 리포트 AI 분석
    - 리포트 품질 평가

### LLM 활용 전략

**Mix of Agents 패턴**:
- 각 에이전트가 특정 LLM에 최적화
- 작업 유형에 따라 적절한 LLM 선택
- 병렬 처리로 성능 최적화

**프롬프트 템플릿**:
- `prompt_templates` 테이블에 저장
- 타입별, KPI별 템플릿 관리
- 버전 관리 지원

## 비동기 작업 처리

### Celery 설정

**브로커**: Redis
**백엔드**: Redis
**워커**: 독립 프로세스

### 주요 태스크

1. **report_tasks.py**
   - `parse_report_task`: 리포트 파싱
   - `extract_document_task`: 문서 추출

2. **evaluation_tasks.py**
   - `run_evaluation_task`: 평가 실행
   - `calculate_scores_task`: 점수 계산

3. **data_collection_tasks.py**
   - `start_collection_job_task`: 수집 작업 시작
   - `collect_data_task`: 데이터 수집
   - `check_job_completion_task`: 작업 완료 확인

4. **award_tasks.py**
   - `run_award_selection_task`: 어워드 선정

### 작업 흐름

```
API 요청 → Celery 태스크 큐 → Worker 실행 → 결과 저장 → 상태 업데이트
```

## 데이터 흐름

### 리포트 업로드 및 평가 프로세스

```
1. 사용자 → Frontend: 리포트 업로드
2. Frontend → Backend API: POST /api/reports/upload
3. Backend API → Celery: 리포트 파싱 작업 큐에 추가
4. Celery Worker → DocumentExtractionService: PDF 파싱
5. Celery Worker → ReportParsingAgent: 섹션 추출
6. Celery Worker → EvaluationAgent: 평가 시작
7. EvaluationAgent → DataCollectionAgent: 데이터 수집
8. EvaluationAgent → LLM Service: AI 분석
9. EvaluationAgent → ScorecardService: 스코어카드 생성
10. Backend → Frontend: 평가 결과 반환
```

### 데이터 수집 프로세스

```
1. 사용자 → Frontend: 수집 작업 시작
2. Frontend → Backend API: POST /api/data-collection/start
3. Backend API → CollectionJob 생성
4. Backend API → Celery: start_collection_job_task 큐에 추가
5. Celery Worker → 리포트 조회 (기간 내)
6. Celery Worker → collect_data_task (각 리포트별)
7. collect_data_task → DataCollectionAgent
8. DataCollectionAgent → PerplexityService: 데이터 수집
9. DataCollectionAgent → DataCollectionLog 저장
10. Celery Worker → CollectionJob 진행 상황 업데이트
11. Frontend → Backend API: GET /api/data-collection/{job_id}/status (폴링)
12. Backend → Frontend: 진행 상황 반환
```

### 평가 프로세스

```
1. 사용자 → Frontend: 평가 시작
2. Frontend → Backend API: POST /api/evaluations/start
3. Backend API → Celery: run_evaluation_task 큐에 추가
4. Celery Worker → EvaluationAgent 실행
5. EvaluationAgent → PerformanceVerificationAgent: 실적 검증
6. EvaluationAgent → StockTrackingAgent: 종목 추적
7. EvaluationAgent → DataCollectionAgent: SNS/언론 데이터 수집
8. EvaluationAgent → LLM Service: AI 분석
9. EvaluationAgent → 점수 계산
10. EvaluationAgent → ScorecardService: 스코어카드 생성
11. Backend → Frontend: 평가 결과 반환
```

## 주요 특징

### 1. 멀티 LLM 활용
- 4개의 LLM 서비스 통합
- 작업 유형별 최적 LLM 선택
- 병렬 처리로 성능 최적화

### 2. 비동기 처리
- Celery를 통한 장시간 작업 처리
- 실시간 진행 상황 추적
- 작업 큐를 통한 부하 분산

### 3. 확장 가능한 구조
- 계층 분리 (API, Service, Data)
- 모듈화된 AI 에이전트
- 독립적인 서비스 컴포넌트

### 4. 데이터 수집 자동화
- Perplexity API를 통한 실시간 데이터 수집
- 프롬프트 템플릿 기반 수집
- 진행 상황 실시간 모니터링

### 5. 문서 처리
- PDF 파싱 (텍스트, 표, 이미지)
- OCR 처리
- 구조화된 데이터 추출

## 개선 가능한 부분

### 1. 테스트
- 단위 테스트 부족
- 통합 테스트 부족
- E2E 테스트 부족

### 2. 에러 처리
- 전역 예외 처리 개선
- 에러 로깅 강화
- 사용자 친화적 에러 메시지

### 3. 성능 최적화
- 데이터베이스 쿼리 최적화
- 캐싱 전략 수립
- API 응답 시간 개선

### 4. 보안
- 인증/인가 시스템
- API 키 관리 강화
- 입력 데이터 검증 강화

### 5. 문서화
- API 문서 자동 생성 (Swagger)
- 코드 주석 보강
- 사용자 가이드 작성

## 결론

이 프로젝트는 AI 기반 애널리스트 평가 시스템으로, 다음과 같은 특징을 가지고 있습니다:

1. **완전한 백엔드 구현**: FastAPI 기반의 RESTful API, 11개의 AI 에이전트, Celery를 통한 비동기 처리
2. **프론트엔드 기본 구조**: Next.js 기반의 React 애플리케이션, 주요 페이지 구현
3. **데이터베이스 설계**: 18개 테이블로 구성된 정규화된 스키마
4. **멀티 LLM 통합**: OpenAI, Anthropic, Google, Perplexity 통합
5. **확장 가능한 아키텍처**: 계층 분리, 모듈화, 독립적인 서비스

전체적으로 잘 구조화된 프로젝트이며, 일부 기능 보완과 테스트 추가를 통해 프로덕션 배포가 가능한 수준입니다.

