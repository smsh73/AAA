# 자료수집 기능 정합성 테스트 체크리스트

## 개요

이 문서는 자료수집(Data Collection) 기능의 정합성을 검증하기 위한 체크리스트입니다.

## 테스트 범위

### 1. 모델 (Models)

#### 1.1 DataCollectionLog 모델
- [x] 모델 정의 존재
- [x] 필수 필드 정의 (analyst_id, collection_type, status)
- [x] 관계 설정 (analyst, company)
- [x] 인덱스 설정 확인

#### 1.2 DataSource 모델
- [x] 모델 정의 존재
- [x] 필수 필드 정의 (source_name, source_type)
- [ ] 관계 설정 확인 필요

#### 1.3 CollectionJob 모델 (작업 추적용)
- [x] **구현 완료: 작업 추적을 위한 모델 생성됨**
- [x] 필드: id, analyst_id, collection_types, status, progress, overall_progress, created_at, updated_at

### 2. 스키마 (Schemas)

#### 2.1 DataCollectionStartRequest
- [x] 스키마 정의 존재
- [x] 필수 필드: analyst_id, collection_types, start_date, end_date

#### 2.2 DataCollectionStartResponse
- [x] 스키마 정의 존재
- [x] 필드: collection_job_id, status, estimated_completion_time

#### 2.3 DataCollectionStatusResponse
- [x] 스키마 정의 존재
- [x] 필드: collection_job_id, status, progress, overall_progress

#### 2.4 DataCollectionLogResponse
- [x] **구현 완료: 로그 조회용 응답 스키마 추가됨**

### 3. API 라우터 (Routers)

#### 3.1 POST /api/data-collection/start
- [x] 라우터 등록 확인
- [x] 엔드포인트 정의 존재
- [x] **구현 완료: DataCollectionService.start_collection 구현됨**

#### 3.2 GET /api/data-collection/{collection_job_id}/status
- [x] 라우터 등록 확인
- [x] 엔드포인트 정의 존재
- [x] **구현 완료: DataCollectionService.get_collection_status 구현됨**

#### 3.3 GET /api/data-collection/logs
- [x] **구현 완료: 수집 로그 조회 API 추가됨**

#### 3.4 GET /api/data-collection/analysts/{analyst_id}/logs
- [x] **구현 완료: 애널리스트별 로그 조회 API 추가됨**

### 4. 서비스 (Services)

#### 4.1 DataCollectionService

##### 4.1.1 start_collection
- [x] **구현 완료: 메서드 구현됨**
- [x] 입력: analyst_id, collection_types, start_date, end_date
- [x] 출력: DataCollectionStartResponse
- [x] 기능:
  - [x] CollectionJob 생성
  - [x] Celery 태스크 큐에 작업 추가
  - [x] 작업 ID 반환

##### 4.1.2 get_collection_status
- [x] **구현 완료: 메서드 구현됨**
- [x] 입력: collection_job_id
- [x] 출력: DataCollectionStatusResponse
- [x] 기능:
  - [x] CollectionJob 조회
  - [x] 진행 상황 계산
  - [x] 상태 반환

##### 4.1.3 start_collection_for_analyst
- [x] 메서드 정의 존재
- [x] 기본 로직 구현 확인
- [ ] 에러 처리 확인 필요

#### 4.2 DataCollectionAgent

##### 4.2.1 collect_data
- [x] 메서드 구현 존재
- [x] Perplexity 통합 확인
- [x] 로그 저장 확인
- [ ] 에러 처리 검증 필요

#### 4.3 PerplexityService

##### 4.3.1 search
- [x] 메서드 구현 존재
- [x] API 통합 확인
- [ ] 타임아웃 처리 확인 필요

### 5. Celery 태스크 (Tasks)

#### 5.1 collect_data_task
- [x] 태스크 정의 존재
- [x] **구현 완료: async 래퍼 구현됨 (run_async 헬퍼 함수)**
- [x] 실제 실행 로직 구현 완료

#### 5.2 start_collection_for_analyst_task
- [x] 태스크 정의 존재
- [x] **구현 완료: async 래퍼 구현됨**
- [x] 실제 실행 로직 구현 완료

#### 5.3 start_collection_job_task
- [x] **구현 완료: 새로운 태스크 추가됨**
- [x] CollectionJob 실행 로직 구현 완료

### 6. 데이터베이스 마이그레이션

#### 6.1 테이블 생성
- [x] DataCollectionLog 테이블
- [x] DataSource 테이블
- [x] **구현 완료: CollectionJob 테이블 모델 생성됨 (마이그레이션 필요)**

#### 6.2 관계 설정
- [x] Analyst - DataCollectionLog 관계
- [x] Company - DataCollectionLog 관계
- [x] **구현 완료: CollectionJob - DataCollectionLog 관계 설정됨**
- [x] Analyst - CollectionJob 관계 설정됨

### 7. 통합 테스트 시나리오

#### 7.1 기본 수집 플로우
1. [ ] POST /api/data-collection/start 호출
2. [ ] CollectionJob 생성 확인
3. [ ] Celery 태스크 실행 확인
4. [ ] DataCollectionLog 생성 확인
5. [ ] GET /api/data-collection/{job_id}/status로 상태 확인

#### 7.2 애널리스트 일괄 등록 시 수집 시작
1. [ ] POST /api/analysts/bulk-import 호출
2. [ ] 애널리스트 생성 확인
3. [ ] 자동 수집 시작 확인 (start_collection_for_analyst_task)
4. [ ] 수집 로그 생성 확인

#### 7.3 에러 처리
1. [ ] Perplexity API 오류 시 로그 저장 확인
2. [ ] 잘못된 analyst_id 처리 확인
3. [ ] 타임아웃 처리 확인

## 구현 완료 내역

### 완료된 항목
1. ✅ **CollectionJob 모델 생성**: 작업 추적을 위한 모델 구현 완료
2. ✅ **DataCollectionService.start_collection 구현**: API에서 호출 가능하도록 구현 완료
3. ✅ **DataCollectionService.get_collection_status 구현**: API에서 호출 가능하도록 구현 완료
4. ✅ **Celery 태스크 async 래퍼 구현**: run_async 헬퍼 함수로 async 함수 실행 가능
5. ✅ **DataCollectionLogResponse 스키마 추가**: 로그 조회 API 응답 스키마 추가
6. ✅ **로그 조회 API 추가**: GET /api/data-collection/logs 구현 완료
7. ✅ **애널리스트별 로그 조회 API 추가**: GET /api/data-collection/analysts/{analyst_id}/logs 구현 완료
8. ✅ **start_collection_job_task 추가**: CollectionJob 실행을 위한 새로운 태스크 추가

### 남은 작업

#### 필수 (Critical)
1. ✅ **완료**: 데이터베이스 마이그레이션 파일 생성됨 (`002_add_collection_job.py`)
2. ⚠️ **대기**: 마이그레이션 실행 필요 (데이터베이스 연결 후 `alembic upgrade head` 실행)

#### 개선 (Enhancement)
1. ✅ **완료**: 작업 완료 자동 감지 로직 추가 (모든 태스크 완료 시 CollectionJob 상태 업데이트)
2. ✅ **완료**: 에러 처리 강화
3. ✅ **완료**: 타임아웃 처리 개선
4. ✅ **완료**: 진행 상황 추적 개선 (실시간 업데이트)

## 우선순위별 구현 계획

### Phase 1: 핵심 기능 구현 (필수)
1. CollectionJob 모델 생성 및 마이그레이션
2. DataCollectionService.start_collection 구현
3. DataCollectionService.get_collection_status 구현
4. Celery 태스크 async 래퍼 구현

### Phase 2: API 보완 (중요)
1. DataCollectionLogResponse 스키마 추가
2. 로그 조회 API 추가
3. 애널리스트별 로그 조회 API 추가

### Phase 3: 개선 (권장)
1. 에러 처리 강화
2. 타임아웃 처리 개선
3. 진행 상황 추적 개선

## 테스트 방법

### 1. 단위 테스트
```python
# 각 서비스 메서드별 단위 테스트 작성 필요
```

### 2. 통합 테스트
```bash
# API 엔드포인트 테스트
curl -X POST http://localhost:8000/api/data-collection/start \
  -H "Content-Type: application/json" \
  -d '{
    "analyst_id": "...",
    "collection_types": ["target_price", "performance"],
    "start_date": "2024-01-01",
    "end_date": "2024-12-31"
  }'
```

### 3. 수동 테스트
1. 애널리스트 일괄 등록 후 자동 수집 확인
2. 수집 로그 조회 확인
3. 작업 상태 조회 확인

