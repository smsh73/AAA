# 마이그레이션 실행 가이드

## 개요

자료수집 기능을 위한 데이터베이스 마이그레이션을 실행하는 방법을 안내합니다.

## 사전 준비

### 1. 데이터베이스 연결 확인

로컬에서 PostgreSQL이 실행 중인지 확인:

```bash
# PostgreSQL 서비스 상태 확인 (macOS)
brew services list | grep postgresql

# 또는 Docker Compose 사용 시
docker-compose ps
```

### 2. 환경 변수 설정

`.env` 파일 또는 환경 변수에 `DATABASE_URL` 설정:

```bash
# 로컬 PostgreSQL 사용 시
export DATABASE_URL="postgresql://user:password@localhost:5432/analyst_awards"

# Docker Compose 사용 시
export DATABASE_URL="postgresql://user:password@localhost:5432/analyst_awards"
```

## 마이그레이션 실행 방법

### 방법 1: Docker Compose 사용 (권장)

```bash
# 프로젝트 루트에서
cd /Users/seungminlee/Downloads/AAA\ 2

# Docker Compose로 서비스 시작
docker-compose up -d postgres

# API 컨테이너에서 마이그레이션 실행
docker-compose exec api alembic upgrade head

# 또는 직접 실행
docker-compose run --rm api alembic upgrade head
```

### 방법 2: 로컬에서 직접 실행

```bash
cd apps/api

# 환경 변수 설정
export DATABASE_URL="postgresql://user:password@localhost:5432/analyst_awards"

# 마이그레이션 실행
alembic upgrade head
```

### 방법 3: Python 스크립트로 실행

```bash
cd apps/api

# 환경 변수 설정
export DATABASE_URL="postgresql://user:password@localhost:5432/analyst_awards"

# Python으로 직접 실행
python -c "
from alembic.config import Config
from alembic import command
from alembic.script import ScriptDirectory
from alembic.runtime.migration import MigrationContext
from sqlalchemy import create_engine
import os

alembic_cfg = Config('alembic.ini')
alembic_cfg.set_main_option('sqlalchemy.url', os.getenv('DATABASE_URL'))
command.upgrade(alembic_cfg, 'head')
"
```

### 방법 4: 수동 SQL 실행

데이터베이스에 직접 연결하여 SQL 실행:

```bash
# PostgreSQL에 연결
psql -U user -d analyst_awards -h localhost

# 또는 Docker Compose 사용 시
docker-compose exec postgres psql -U user -d analyst_awards
```

그 다음 다음 SQL 실행:

```sql
-- collection_jobs 테이블 생성
CREATE TABLE IF NOT EXISTS collection_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    analyst_id UUID NOT NULL REFERENCES analysts(id),
    collection_types TEXT[] NOT NULL,
    start_date TIMESTAMP WITH TIME ZONE NOT NULL,
    end_date TIMESTAMP WITH TIME ZONE NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    progress JSONB DEFAULT '{}',
    overall_progress VARCHAR(10) DEFAULT '0.0',
    estimated_completion_time TIMESTAMP WITH TIME ZONE,
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    error_message VARCHAR(500),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_collection_jobs_analyst_id ON collection_jobs(analyst_id);
CREATE INDEX IF NOT EXISTS idx_collection_jobs_status ON collection_jobs(status);

-- data_collection_logs 테이블 수정
ALTER TABLE data_collection_logs 
ADD COLUMN IF NOT EXISTS collection_job_id UUID REFERENCES collection_jobs(id);

CREATE INDEX IF NOT EXISTS idx_data_collection_logs_collection_job_id 
ON data_collection_logs(collection_job_id);
```

## 마이그레이션 확인

### 1. Alembic 버전 확인

```bash
cd apps/api
alembic current
alembic history
```

### 2. 데이터베이스 직접 확인

```sql
-- 테이블 존재 확인
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' AND table_name = 'collection_jobs';

-- 컬럼 확인
SELECT column_name, data_type FROM information_schema.columns 
WHERE table_name = 'collection_jobs'
ORDER BY ordinal_position;

-- 컬럼 추가 확인
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'data_collection_logs' AND column_name = 'collection_job_id';

-- 인덱스 확인
SELECT indexname FROM pg_indexes 
WHERE tablename IN ('collection_jobs', 'data_collection_logs');
```

## 문제 해결

### 오류: "role 'user' does not exist"

**원인**: PostgreSQL 사용자가 존재하지 않음

**해결 방법**:
```bash
# PostgreSQL에 접속
psql -U postgres

# 사용자 생성
CREATE USER user WITH PASSWORD 'password';
CREATE DATABASE analyst_awards OWNER user;
GRANT ALL PRIVILEGES ON DATABASE analyst_awards TO user;
```

### 오류: "connection refused"

**원인**: PostgreSQL 서비스가 실행되지 않음

**해결 방법**:
```bash
# macOS (Homebrew)
brew services start postgresql@14

# 또는 Docker Compose
docker-compose up -d postgres
```

### 오류: "database does not exist"

**원인**: 데이터베이스가 생성되지 않음

**해결 방법**:
```bash
# PostgreSQL에 접속
psql -U postgres

# 데이터베이스 생성
CREATE DATABASE analyst_awards;
```

## 롤백 방법

마이그레이션을 롤백해야 하는 경우:

```bash
cd apps/api
alembic downgrade -1
```

또는 수동으로:

```sql
-- 인덱스 삭제
DROP INDEX IF EXISTS idx_data_collection_logs_collection_job_id;
DROP INDEX IF EXISTS idx_collection_jobs_status;
DROP INDEX IF EXISTS idx_collection_jobs_analyst_id;

-- 컬럼 삭제
ALTER TABLE data_collection_logs DROP COLUMN IF EXISTS collection_job_id;

-- 테이블 삭제
DROP TABLE IF EXISTS collection_jobs;
```

## 다음 단계

마이그레이션 실행 후:

1. ✅ API 서버 재시작
2. ✅ Celery 워커 재시작
3. ✅ 통합 테스트 실행
4. ✅ 기능 동작 확인

