# 자료수집 기능 마이그레이션 가이드

## 개요

자료수집 기능 구현을 위해 새로운 모델(CollectionJob)이 추가되었고, 기존 모델(DataCollectionLog)에 컬럼이 추가되었습니다. 데이터베이스 마이그레이션이 필요합니다.

## 변경 사항

### 1. 새로운 테이블: collection_jobs

```sql
CREATE TABLE collection_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    analyst_id UUID NOT NULL REFERENCES analysts(id),
    collection_types TEXT[] NOT NULL,
    start_date TIMESTAMP WITH TIME ZONE NOT NULL,
    end_date TIMESTAMP WITH TIME ZONE NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    progress JSONB DEFAULT '{}',
    overall_progress VARCHAR(10) DEFAULT '0.0',
    estimated_completion_time TIMESTAMP WITH TIME ZONE,
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    error_message VARCHAR(500),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_collection_jobs_analyst_id ON collection_jobs(analyst_id);
CREATE INDEX idx_collection_jobs_status ON collection_jobs(status);
```

### 2. 기존 테이블 수정: data_collection_logs

```sql
ALTER TABLE data_collection_logs 
ADD COLUMN collection_job_id UUID REFERENCES collection_jobs(id);

CREATE INDEX idx_data_collection_logs_collection_job_id ON data_collection_logs(collection_job_id);
```

## 마이그레이션 실행 방법

### 방법 1: Alembic 사용 (권장)

```bash
cd apps/api

# 마이그레이션 파일 생성
alembic revision --autogenerate -m "Add collection_job model and update data_collection_log"

# 마이그레이션 실행
alembic upgrade head
```

### 방법 2: 수동 SQL 실행

위의 SQL 문을 직접 데이터베이스에 실행합니다.

### 방법 3: init_db.py 스크립트 사용

```bash
cd apps/api
python scripts/init_db.py
```

**주의**: 이 방법은 기존 데이터를 삭제할 수 있으므로 개발 환경에서만 사용하세요.

## 마이그레이션 후 확인

1. 테이블 생성 확인:
```sql
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' AND table_name = 'collection_jobs';
```

2. 컬럼 추가 확인:
```sql
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'data_collection_logs' AND column_name = 'collection_job_id';
```

3. 인덱스 확인:
```sql
SELECT indexname FROM pg_indexes 
WHERE tablename IN ('collection_jobs', 'data_collection_logs');
```

## 롤백 방법

마이그레이션을 롤백해야 하는 경우:

### Alembic 사용 시:
```bash
alembic downgrade -1
```

### 수동 롤백:
```sql
-- 인덱스 삭제
DROP INDEX IF EXISTS idx_data_collection_logs_collection_job_id;
DROP INDEX IF EXISTS idx_collection_jobs_status;
DROP INDEX IF EXISTS idx_collection_jobs_analyst_id;

-- 컬럼 삭제
ALTER TABLE data_collection_logs DROP COLUMN IF EXISTS collection_job_id;

-- 테이블 삭제
DROP TABLE IF EXISTS collection_jobs;
```

## 주의사항

1. **프로덕션 환경**: 마이그레이션 전에 반드시 백업을 수행하세요.
2. **데이터 무결성**: 기존 data_collection_logs 레코드의 collection_job_id는 NULL이 될 수 있습니다.
3. **성능**: 대량의 데이터가 있는 경우 인덱스 생성에 시간이 걸릴 수 있습니다.

