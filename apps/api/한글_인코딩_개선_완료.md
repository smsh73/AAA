# 한글 인코딩 처리 개선 완료

## 개선 내역

### 문제점
기존 코드에서 한글 텍스트 추출 시 인코딩 처리가 명시적으로 되어 있지 않아 한글이 깨질 수 있는 문제가 있었습니다.

### 개선 사항

#### 1. PDF 문자열 디코딩 함수 추가 ✅

`_decode_pdf_string()` 메서드를 추가하여 다양한 인코딩을 자동으로 처리합니다:

```python
def _decode_pdf_string(self, value: Any) -> str:
    """PDF 문자열을 UTF-8로 디코딩"""
    # 1. UTF-8 시도 (가장 일반적)
    # 2. CP949 시도 (한국어 Windows 인코딩)
    # 3. EUC-KR 시도 (한국어 Unix 인코딩)
    # 4. latin-1 시도 (마지막 수단, 손실 가능)
```

**처리 순서:**
1. UTF-8 디코딩 시도
2. 실패 시 CP949 (한국어 Windows) 시도
3. 실패 시 EUC-KR 시도
4. 모두 실패 시 latin-1 (에러 대체 모드)

#### 2. 메타데이터 추출 시 인코딩 처리 ✅

PyPDF2로 추출한 메타데이터(제목, 작성자 등)에 한글이 포함된 경우를 대비하여 디코딩 처리:

```python
"title": self._decode_pdf_string(metadata.get("/Title", "")),
"author": self._decode_pdf_string(metadata.get("/Author", "")),
"subject": self._decode_pdf_string(metadata.get("/Subject", "")),
```

#### 3. 텍스트 추출 시 인코딩 보정 ✅

**전체 텍스트 추출:**
- `page.extract_text()` 결과가 bytes인 경우 디코딩
- 문자열이 아닌 경우 문자열로 변환
- 한글 언어 태그 추가 (`"language": "ko"`)

**단어별 추출:**
- 각 단어의 텍스트를 추출할 때 인코딩 보정
- bytes 타입인 경우 `_decode_pdf_string()` 사용

#### 4. 표 데이터 정제 시 인코딩 처리 ✅

표의 각 셀 데이터에 대해:
- bytes 타입인 경우 디코딩
- 문자열이 아닌 경우 문자열로 변환
- 공백 정리

```python
for cell in row:
    if cell:
        cell_text = cell
        if isinstance(cell_text, bytes):
            cell_text = self._decode_pdf_string(cell_text)
        elif not isinstance(cell_text, str):
            cell_text = str(cell_text)
        cleaned_row.append(cell_text.strip())
```

#### 5. pdfplumber 인코딩 명시 ✅

pdfplumber는 기본적으로 UTF-8을 사용하지만, 명시적으로 설정:

```python
try:
    with pdfplumber.open(file_path, encoding='utf-8') as pdf:
        # ...
except TypeError:
    # encoding 파라미터를 지원하지 않는 경우 대체
    with pdfplumber.open(file_path) as pdf:
        # ...
```

## 지원하는 인코딩

### 자동 감지 및 변환
1. **UTF-8**: 국제 표준, 가장 일반적
2. **CP949**: 한국어 Windows 인코딩 (EUC-KR 확장)
3. **EUC-KR**: 한국어 Unix 인코딩
4. **Latin-1**: 마지막 수단 (일부 문자 손실 가능)

## 데이터베이스 저장

PostgreSQL은 기본적으로 UTF-8을 사용하므로:
- SQLAlchemy 모델의 `Text` 타입은 UTF-8로 저장
- JSONB 필드도 UTF-8로 저장
- 별도의 인코딩 변환 불필요

## 테스트 방법

### 1. 한글 포함 PDF 테스트

```python
# 한글이 포함된 PDF 파일 업로드
POST /api/reports/upload
{
  "file": <한글_포함_PDF>,
  "analyst_id": "..."
}

# 추출된 텍스트 확인
GET /api/reports/{report_id}

# 한글이 제대로 추출되었는지 확인
```

### 2. 인코딩 확인

```python
# 추출된 텍스트의 인코딩 확인
extracted_text = result["texts"][0]["content"]
print(f"인코딩: {extracted_text.encode('utf-8')}")
print(f"한글 포함: {bool(re.search(r'[가-힣]', extracted_text))}")
```

## 주의사항

### 1. PDF 인코딩 다양성

PDF 파일은 다양한 인코딩을 사용할 수 있습니다:
- 최신 PDF: 주로 UTF-8
- 구형 PDF: CP949, EUC-KR 등
- 이미지 기반 PDF: OCR 필요

### 2. OCR 텍스트

PaddleOCR은 기본적으로 UTF-8로 텍스트를 반환하므로 추가 인코딩 처리가 필요 없습니다.

### 3. 파일 경로

파일 경로에 한글이 포함된 경우:
- Python 3는 기본적으로 UTF-8을 사용
- 파일 시스템에 따라 다를 수 있음
- 문제 발생 시 경로를 URL 인코딩하여 처리

## 개선 효과

### 이전
- 한글 텍스트가 깨질 수 있음
- 메타데이터의 한글이 깨질 수 있음
- 표 데이터의 한글이 깨질 수 있음

### 이후
- 다양한 인코딩 자동 감지 및 변환
- 한글 텍스트 정상 추출
- 메타데이터 한글 보존
- 표 데이터 한글 보존
- 언어 태그 추가로 한글 구분 가능

## 추가 개선 가능 사항

1. **인코딩 자동 감지**: chardet 라이브러리 사용
2. **한글 감지**: 정규식으로 한글 포함 여부 확인
3. **인코딩 로깅**: 어떤 인코딩이 사용되었는지 로그 기록

