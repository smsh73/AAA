# 애널리스트 데이터 생성 가이드

이 가이드는 Excel 파일에서 애널리스트 데이터를 추출하여 데이터베이스에 등록하는 방법을 설명합니다.

## 개요

`old_assets/증권사 리서치센터 애널리스트 리스트(반도체 자동차 방산 금융 최종) (1).xlsx` 파일에 있는 애널리스트 정보를 데이터베이스에 등록합니다.

## 사전 준비

### 1. 필요한 패키지 확인

다음 패키지들이 설치되어 있어야 합니다:

- `pandas`: Excel 파일 읽기
- `openpyxl`: Excel 파일 처리 엔진

이미 `requirements.txt`에 포함되어 있으므로 다음 명령어로 설치할 수 있습니다:

```bash
cd apps/api
pip install -r requirements.txt
```

### 2. 데이터베이스 연결 확인

환경 변수 `DATABASE_URL`이 올바르게 설정되어 있는지 확인하세요:

```bash
# .env 파일 또는 환경 변수에 설정
DATABASE_URL=postgresql://user:password@localhost:5432/analyst_awards
```

### 3. 데이터베이스 테이블 생성

데이터베이스 테이블이 생성되어 있지 않다면 먼저 초기화하세요:

```bash
cd apps/api
python scripts/init_db.py
```

## 실행 방법

### 방법 1: 스크립트 직접 실행

```bash
cd apps/api
python scripts/import_analysts_from_excel.py
```

### 방법 2: Python 모듈로 실행

```bash
cd apps/api
python -m scripts.import_analysts_from_excel
```

## 스크립트 동작 방식

1. **Excel 파일 읽기**: 지정된 Excel 파일의 모든 시트를 읽습니다.
2. **데이터 추출**: 각 시트에서 다음 정보를 추출합니다:
   - 이름 (필수)
   - 증권사명 (필수)
   - 부서 (선택)
   - 섹터 (시트명 또는 컬럼에서 추출)
   - 이메일 (선택)
3. **중복 체크**: 이름과 증권사명이 동일한 애널리스트가 이미 존재하는지 확인합니다.
4. **데이터베이스 등록**: 중복이 아닌 경우 데이터베이스에 등록합니다.

## Excel 파일 형식

스크립트는 다음 컬럼명을 자동으로 인식합니다:

### 이름 (필수)
- `이름`, `애널리스트명`, `애널리스트`, `Name`, `name`, `NAME`

### 증권사명 (필수)
- `증권사`, `증권사명`, `회사`, `Firm`, `firm`, `FIRM`

### 부서 (선택)
- `부서`, `소속부서`, `Department`, `department`, `DEPARTMENT`

### 섹터 (선택)
- `섹터`, `업종`, `Sector`, `sector`, `SECTOR`
- 시트명에서도 자동 추출 (예: "반도체", "자동차", "방산", "금융")

### 이메일 (선택)
- `이메일`, `Email`, `email`, `EMAIL`, `E-mail`

## 섹터 자동 인식

시트명에 다음 키워드가 포함되어 있으면 자동으로 섹터를 설정합니다:

- `반도체` 또는 `semiconductor` → 섹터: "반도체"
- `자동차` 또는 `auto`/`automotive` → 섹터: "자동차"
- `방산` 또는 `defense` → 섹터: "방산"
- `금융` 또는 `finance`/`financial` → 섹터: "금융"

## 실행 결과

스크립트 실행 후 다음과 같은 결과가 출력됩니다:

```
Excel 파일 읽는 중: /path/to/file.xlsx

시트 '반도체' 처리 중... (행 수: 50)
  발견된 컬럼: {'name': '이름', 'firm': '증권사명', 'sector': '섹터'}

총 150개의 애널리스트 레코드 추출됨

데이터베이스에 등록 중... (총 150개)
  [1/150] 등록: 홍길동 - 삼성증권 (반도체)
  [2/150] 등록: 김철수 - KB증권 (자동차)
  ...

데이터베이스 커밋 완료!

============================================================
등록 결과
============================================================
총 레코드 수: 150
성공: 145
실패: 0
스킵 (중복): 5
```

## 문제 해결

### Excel 파일을 찾을 수 없음

```
오류: Excel 파일을 찾을 수 없습니다: /path/to/file.xlsx
```

**해결 방법**: 
- 파일 경로가 올바른지 확인하세요.
- 파일명이 정확한지 확인하세요 (특히 한글 파일명).
- 스크립트 내의 파일 경로를 수정할 수 있습니다.

### 데이터베이스 연결 오류

```
오류 발생: could not connect to server
```

**해결 방법**:
- PostgreSQL 서버가 실행 중인지 확인하세요.
- `DATABASE_URL` 환경 변수가 올바른지 확인하세요.
- 데이터베이스가 생성되어 있는지 확인하세요.

### 패키지 설치 오류

```
ModuleNotFoundError: No module named 'pandas'
```

**해결 방법**:
```bash
cd apps/api
pip install pandas openpyxl
```

또는

```bash
pip install -r requirements.txt
```

## API를 통한 등록 (대안)

스크립트 대신 API를 통해 Excel 파일을 업로드할 수도 있습니다:

```bash
curl -X POST "http://localhost:8000/api/analysts/bulk-import" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@/path/to/file.xlsx"
```

또는 프론트엔드에서 파일 업로드 기능을 사용하세요.

## 다음 단계

애널리스트 데이터가 등록되면:

1. **데이터 수집**: 각 애널리스트에 대한 자료 수집이 자동으로 시작됩니다.
2. **리포트 업로드**: 애널리스트의 리포트를 업로드하여 평가를 시작할 수 있습니다.
3. **평가 실행**: 리포트에 대한 AI 평가를 실행할 수 있습니다.

## 참고

- 스크립트는 중복된 애널리스트를 자동으로 스킵합니다 (이름 + 증권사명 기준).
- 섹터 정보가 없어도 등록은 가능하지만, 섹터별 필터링에는 유용합니다.
- 대량의 데이터를 등록할 때는 시간이 걸릴 수 있습니다.

